<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.boot.domain.result.model.mapper.ResultMapper">

    <!-- 증상 정보 조회 (띄어쓰기 무시) -->
    <select id="getSymptomInfo" resultType="String">
        SELECT SYMPTOM_DETAIL
        FROM SYMPTOM
        WHERE REPLACE(SYMPTOM_NAME, ' ', '') = REPLACE(#{keyword}, ' ', '')
    </select>

    <!-- 병원 이름으로 검색 (띄어쓰기 무시, LIKE, 이름순 정렬) -->
    <select id="searchHospitalsByName" resultType="com.hospital.boot.domain.hospital.model.vo.Hospital">
        SELECT
            HOSPITAL_ID as hospitalId,
            HOSPITAL_NAME as hospitalName,
            ADDRESS as address,
            HOSPITAL_GRADE as hospitalGrade,
            HOSPITAL_TYPE as hospitalType,
            DETAILS as details,
            OPERATING_HOURS as operatingHours,
            LUNCH_TIME as lunchTime,
            EMERGENCY_YN as emergencyYn,
            PHONE as phone,
            LONGITUDE as longitude,
            LATITUDE as latitude,
            SIMPLE_MAP as simpleMap,
            MAIN_IMAGE as mainImage,
            WEBSITE_URL as websiteURL,
            NEARBY_DISTRICTS as nearbyDistricts
        FROM HOSPITALS
        WHERE REPLACE(HOSPITAL_NAME, ' ', '') LIKE '%' || REPLACE(#{keyword}, ' ', '') || '%'
        ORDER BY HOSPITAL_NAME
    </select>

    <!-- 질병 검색 (띄어쓰기 무시, 정확도순: 이름 일치 우선, 그 다음 설명 일치) -->
    <select id="searchDiseasesByNameOrDescription" resultType="map">
        WITH AllSymptoms AS (
            SELECT
                DISEASE_NAME,
                LISTAGG(SYMPTOM_NAME, ', ')
                    WITHIN GROUP (ORDER BY SYMPTOM_NAME) AS all_symptoms
            FROM (
                SELECT DISTINCT DISEASE_NAME, SYMPTOM_NAME
                FROM DISEASE_SYMPTOM_MAPPINGS
            )
            GROUP BY DISEASE_NAME
        ),
        MatchedDiseases AS (
            SELECT
                d.DISEASE_NO,
                d.DISEASE_NAME,
                d.IMAGE_URL,
                d.DESCRIPTION,
                d.TOTAL_PATIENTS,
                CASE
                    WHEN REPLACE(d.DISEASE_NAME, ' ', '') LIKE '%' || REPLACE(#{keyword}, ' ', '') || '%' THEN 1
                    ELSE 2
                END as matchPriority
            FROM DISEASES d
            WHERE REPLACE(d.DISEASE_NAME, ' ', '') LIKE '%' || REPLACE(#{keyword}, ' ', '') || '%'
               OR REPLACE(d.DESCRIPTION, ' ', '') LIKE '%' || REPLACE(#{keyword}, ' ', '') || '%'
        )
        SELECT
            md.DISEASE_NO as diseaseNo,
            md.DISEASE_NAME as diseaseName,
            md.IMAGE_URL as imageUrl,
            md.DESCRIPTION as description,
            md.TOTAL_PATIENTS as totalPatients,
            md.matchPriority,
            LISTAGG(dd.DEPARTMENT_NAME, ', ')
                WITHIN GROUP (ORDER BY dd.DEPARTMENT_NAME) as department,
            asym.all_symptoms as symptoms
        FROM MatchedDiseases md
            LEFT JOIN DISEASE_DEPARTMENTS dd ON md.DISEASE_NAME = dd.DISEASE_NAME
            LEFT JOIN AllSymptoms asym ON md.DISEASE_NAME = asym.DISEASE_NAME
        GROUP BY md.DISEASE_NO, md.DISEASE_NAME, md.IMAGE_URL, md.DESCRIPTION, md.TOTAL_PATIENTS, md.matchPriority, asym.all_symptoms
        ORDER BY md.matchPriority, md.TOTAL_PATIENTS DESC, md.DISEASE_NAME
    </select>

</mapper>