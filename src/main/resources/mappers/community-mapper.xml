<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.boot.domain.community.model.mapper.SearchMapper">
	<!-- 게시글 목록 -->
    <select id="selectPostList"
            resultType="com.hospital.boot.domain.community.model.vo.Community">
        SELECT
            POST_ID      AS postId,
            MEMBER_ID    AS memberId,
            CATEGORY     AS category,
            TITLE        AS title,
            CONTENT      AS content,
            VIEWS        AS views,
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI') AS createdAt,
            TO_CHAR(NVL(UPDATED_AT, CREATED_AT), 'YYYY-MM-DD HH24:MI') AS updatedAt,
            STATUS       AS status
        FROM COMMUNITY_POST
        WHERE (#{category} = 'all' OR CATEGORY = #{category})
          AND (
                #{keyword} IS NULL
             OR #{keyword} = ''
             OR TITLE   LIKE '%' || #{keyword} || '%'
             OR CONTENT LIKE '%' || #{keyword} || '%'
          )
          AND STATUS = 'ACTIVE'
        ORDER BY POST_ID DESC
    </select>

    <!-- 게시글 상세 -->
    <select id="selectPostDetail"
            resultType="com.hospital.boot.domain.community.model.vo.Community">
        SELECT
            POST_ID      AS postId,
            MEMBER_ID    AS memberId,
            CATEGORY     AS category,
            TITLE        AS title,
            CONTENT      AS content,
            VIEWS        AS views,
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI') AS createdAt,
            TO_CHAR(NVL(UPDATED_AT, CREATED_AT), 'YYYY-MM-DD HH24:MI') AS updatedAt,
            STATUS       AS status
        FROM COMMUNITY_POST
        WHERE POST_ID = #{postId}
          AND STATUS = 'ACTIVE'
    </select>

    <!-- 조회수 증가 -->
    <update id="increaseViewCount">
        UPDATE COMMUNITY_POST
        SET VIEWS = VIEWS + 1
        WHERE POST_ID = #{postId}
    </update>

    <!-- 게시글 작성 -->
    <insert id="insertPost"
            parameterType="com.hospital.boot.domain.community.model.vo.Community">
        <selectKey keyProperty="postId" resultType="long" order="BEFORE">
            SELECT SEQ_COMMUNITY_POST.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO COMMUNITY_POST
        (
            POST_ID,
            MEMBER_ID,
            CATEGORY,
            TITLE,
            CONTENT,
            VIEWS,
            CREATED_AT,
            STATUS
        )
        VALUES
        (
            #{postId},
            #{memberId},
            #{category},
            #{title},
            #{content},
            0,
            SYSDATE,
            'ACTIVE'
        )
    </insert>

    <!-- 댓글 목록 -->
    <select id="selectComments"
            resultType="com.hospital.boot.domain.community.model.vo.CommunityComment">
        SELECT
            COMMENT_ID   AS commentId,
            POST_ID      AS postId,
            MEMBER_ID    AS memberId,
            CONTENT      AS content,
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI') AS createdAt,
            TO_CHAR(NVL(UPDATED_AT, CREATED_AT), 'YYYY-MM-DD HH24:MI') AS updatedAt
        FROM COMMUNITY_COMMENT
        WHERE POST_ID = #{postId}
        ORDER BY COMMENT_ID DESC
    </select>

    <!-- 댓글 작성 -->
    <insert id="insertComment"
            parameterType="com.hospital.boot.domain.community.model.vo.CommunityComment">
        <selectKey keyProperty="commentId" resultType="long" order="BEFORE">
            SELECT SEQ_COMMUNITY_COMMENT.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO COMMUNITY_COMMENT
        (
            COMMENT_ID,
            POST_ID,
            MEMBER_ID,
            CONTENT,
            CREATED_AT
        )
        VALUES
        (
            #{commentId},
            #{postId},
            #{memberId},
            #{content},
            SYSDATE
        )
    </insert>
</mapper>