<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.boot.domain.community.model.mapper.CommunityMapper">

    <select id="selectPostList"
            resultType="com.hospital.boot.app.community.dto.CommunityPostDto">
        SELECT
            p.POST_ID AS postId,
            p.MEMBER_ID AS memberId,
            m.USER_NAME AS author,
            p.CATEGORY AS category,
            p.TITLE AS title,
            p.CONTENT AS content,
            p.VIEWS AS views,
            p.CREATED_AT AS createdAt,
            (SELECT COUNT(*) FROM COMMUNITY_COMMENT WHERE POST_ID = p.POST_ID) AS commentCount
        FROM COMMUNITY_POST p
        JOIN MEMBER m ON p.MEMBER_ID = m.MEMBER_ID
        WHERE p.STATUS = 'ACTIVE'
        <if test="category != 'all'">
            AND p.CATEGORY = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (LOWER(p.TITLE) LIKE '%' || LOWER(#{keyword}) || '%')
        </if>
        ORDER BY p.POST_ID DESC
    </select>
    
    <update id="increaseViews">
	    UPDATE COMMUNITY_POST
	    SET VIEWS = VIEWS + 1
	    WHERE POST_ID = #{postId}
	</update>

    <select id="selectPostDetail"
            parameterType="long"
            resultType="com.hospital.boot.app.community.dto.CommunityPostDto">
        SELECT
            p.POST_ID AS postId,
            p.MEMBER_ID AS memberId,
            m.USER_NAME AS author,
            p.CATEGORY AS category,
            p.TITLE AS title,
            p.CONTENT AS content,
            p.VIEWS AS views,
            p.CREATED_AT AS createdAt,
            (SELECT COUNT(*) FROM COMMUNITY_COMMENT WHERE POST_ID = p.POST_ID) AS commentCount
        FROM COMMUNITY_POST p
        JOIN MEMBER m ON p.MEMBER_ID = m.MEMBER_ID
        WHERE p.POST_ID = #{postId}
    </select>

    <insert id="insertPost"
            parameterType="com.hospital.boot.domain.community.model.vo.Community">
        <selectKey keyProperty="postId" resultType="long" order="BEFORE">
            SELECT SEQ_COMMUNITY_POST.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO COMMUNITY_POST
        (POST_ID, MEMBER_ID, CATEGORY, TITLE, CONTENT, VIEWS, STATUS, CREATED_AT)
        VALUES
        (#{postId}, #{memberId}, #{category}, #{title}, #{content}, 0, 'ACTIVE', SYSDATE)
    </insert>

    <select id="selectCommentList"
            parameterType="long"
            resultType="com.hospital.boot.app.community.dto.CommunityCommentDto">
        SELECT
            c.COMMENT_ID AS commentId,
            c.POST_ID AS postId,
            c.MEMBER_ID AS memberId,
            m.USER_NAME AS author,
            c.CONTENT AS content,
            c.CREATED_AT AS createdAt
        FROM COMMUNITY_COMMENT c
        JOIN MEMBER m ON c.MEMBER_ID = m.MEMBER_ID
        WHERE c.POST_ID = #{postId}
        ORDER BY c.COMMENT_ID DESC
    </select>

    <insert id="insertComment"
            parameterType="com.hospital.boot.domain.community.model.vo.CommunityComment">
        <selectKey keyProperty="commentId" resultType="long" order="BEFORE">
            SELECT SEQ_COMMUNITY_COMMENT.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO COMMUNITY_COMMENT
            (COMMENT_ID, POST_ID, MEMBER_ID, CONTENT, CREATED_AT)
        VALUES
            (#{commentId}, #{postId}, #{memberId}, #{content}, SYSDATE)
    </insert>
    
    <delete id="deletePost">
       DELETE FROM COMMUNITY_POST
       WHERE POST_ID = #{postId}
         AND MEMBER_ID = #{memberId}
   </delete>
   
   <select id="countPostsByMember" resultType="int">
        SELECT COUNT(*)
        FROM COMMUNITY_POST
        WHERE MEMBER_ID = #{memberId}
          AND STATUS = 'ACTIVE'
    </select>

    <update id="updatePost">
        UPDATE COMMUNITY_POST
        SET TITLE = #{title},
            CONTENT = #{content},
            CATEGORY = #{category},
            UPDATED_AT = SYSDATE
        WHERE POST_ID = #{postId}
    </update>

    <update id="adminDeletePost">
        UPDATE COMMUNITY_POST
        SET STATUS = 'DELETED'
        WHERE POST_ID = #{postId}
    </update>
</mapper>