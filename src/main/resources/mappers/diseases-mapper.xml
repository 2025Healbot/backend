<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.boot.domain.diseases.model.mapper.DiseasesMapper">
    <select id="findByName" resultType="map">
        WITH AllSymptoms AS (
            SELECT
                DISEASE_NAME,
                LISTAGG(SYMPTOM_NAME, ', ')
                    WITHIN GROUP (ORDER BY SYMPTOM_NAME) AS all_symptoms
            FROM (
                SELECT DISTINCT DISEASE_NAME, SYMPTOM_NAME
                FROM DISEASE_SYMPTOM_MAPPINGS
            )
            GROUP BY DISEASE_NAME
        )
        SELECT
            d.DISEASE_NO AS "diseaseNo",
            d.DISEASE_NAME AS "질환명",
            LISTAGG(dd.DEPARTMENT_NAME, ', ')
                WITHIN GROUP (ORDER BY dd.DEPARTMENT_NAME) AS "진료과",
            asym.all_symptoms AS "전체증상목록",
            d.IMAGE_URL AS "이미지",
            d.DESCRIPTION AS "설명",
            d.TOTAL_PATIENTS AS "환자수"
        FROM DISEASES d
            LEFT JOIN DISEASE_DEPARTMENTS dd ON d.DISEASE_NAME = dd.DISEASE_NAME
            LEFT JOIN AllSymptoms asym ON d.DISEASE_NAME = asym.DISEASE_NAME
        WHERE d.DISEASE_NAME = #{diseaseName}
        GROUP BY d.DISEASE_NO, d.DISEASE_NAME, d.TOTAL_PATIENTS, d.IMAGE_URL, d.DESCRIPTION, asym.all_symptoms
    </select>

    <select id="allSymptoms" resultType="String">
        SELECT DISTINCT SYMPTOM_NAME AS symptom
        FROM DISEASE_SYMPTOM_MAPPINGS
        ORDER BY symptom
    </select>

    <select id="findDiseasesBySymptoms" resultType="map">
        WITH InputSymptoms AS (
            <foreach collection="symptoms" item="symptom" separator=" UNION ALL ">
                SELECT #{symptom} AS symptom_name FROM DUAL
            </foreach>
        ),
        InputCount AS (
            SELECT COUNT(*) AS total_input FROM InputSymptoms
        ),
        MatchedDiseases AS (
            SELECT
                dsm.DISEASE_NAME,
                COUNT(DISTINCT dsm.SYMPTOM_NAME) AS matched_count
            FROM DISEASE_SYMPTOM_MAPPINGS dsm
                JOIN InputSymptoms inp
                    ON dsm.SYMPTOM_NAME = inp.symptom_name
            GROUP BY dsm.DISEASE_NAME
        ),
        AllSymptoms AS (
            SELECT
                DISEASE_NAME,
                LISTAGG(SYMPTOM_NAME, ', ')
                        WITHIN GROUP (ORDER BY SYMPTOM_NAME) AS all_symptoms
            FROM (
                SELECT DISTINCT DISEASE_NAME, SYMPTOM_NAME
                FROM DISEASE_SYMPTOM_MAPPINGS
            )
            GROUP BY DISEASE_NAME
        )
        SELECT
            md.DISEASE_NAME AS "질환명",
            LISTAGG(dd.DEPARTMENT_NAME, ', ')
                    WITHIN GROUP (ORDER BY dd.DEPARTMENT_NAME) AS "진료과",
            asym.all_symptoms AS "전체증상목록",
            d.IMAGE_URL AS "이미지",
            d.DESCRIPTION AS "설명",
            d.TOTAL_PATIENTS AS "환자수"
        FROM MatchedDiseases md
                 CROSS JOIN InputCount ic
                 JOIN DISEASES d ON md.DISEASE_NAME = d.DISEASE_NAME
                 LEFT JOIN DISEASE_DEPARTMENTS dd ON d.DISEASE_NAME = dd.DISEASE_NAME
                 LEFT JOIN AllSymptoms asym ON d.DISEASE_NAME = asym.DISEASE_NAME
        WHERE md.matched_count >= 1
        GROUP BY md.DISEASE_NAME, md.matched_count, d.total_patients, d.IMAGE_URL, d.DESCRIPTION, asym.all_symptoms
        ORDER BY
            md.matched_count DESC,
            d.total_patients DESC NULLS LAST
            FETCH FIRST 20 ROWS ONLY
    </select>

    <select id="findPopularDiseases" resultType="map">
        WITH AllSymptoms AS (
            SELECT
                DISEASE_NAME,
                LISTAGG(SYMPTOM_NAME, ', ')
                    WITHIN GROUP (ORDER BY SYMPTOM_NAME) AS all_symptoms
            FROM (
                SELECT DISTINCT DISEASE_NAME, SYMPTOM_NAME
                FROM DISEASE_SYMPTOM_MAPPINGS
            )
            GROUP BY DISEASE_NAME
        )
        SELECT
            d.DISEASE_NAME AS "질환명",
            LISTAGG(dd.DEPARTMENT_NAME, ', ')
                WITHIN GROUP (ORDER BY dd.DEPARTMENT_NAME) AS "진료과",
            asym.all_symptoms AS "전체증상목록",
            d.IMAGE_URL AS "이미지",
            d.DESCRIPTION AS "설명",
            d.TOTAL_PATIENTS AS "환자수"
        FROM DISEASES d
            LEFT JOIN DISEASE_DEPARTMENTS dd ON d.DISEASE_NAME = dd.DISEASE_NAME
            LEFT JOIN AllSymptoms asym ON d.DISEASE_NAME = asym.DISEASE_NAME
        GROUP BY d.DISEASE_NAME, d.TOTAL_PATIENTS, d.IMAGE_URL, d.DESCRIPTION, asym.all_symptoms
        ORDER BY d.TOTAL_PATIENTS DESC NULLS LAST
        FETCH FIRST 20 ROWS ONLY
    </select>

    <select id="findAllDiseases" resultType="map">
        WITH AllSymptoms AS (
            SELECT
                DISEASE_NAME,
                LISTAGG(SYMPTOM_NAME, ', ')
                    WITHIN GROUP (ORDER BY SYMPTOM_NAME) AS all_symptoms
            FROM (
                SELECT DISTINCT DISEASE_NAME, SYMPTOM_NAME
                FROM DISEASE_SYMPTOM_MAPPINGS
            )
            GROUP BY DISEASE_NAME
        )
        SELECT
            d.DISEASE_NO AS "diseaseNo",
            d.DISEASE_NAME AS "질환명",
            LISTAGG(dd.DEPARTMENT_NAME, ', ')
                WITHIN GROUP (ORDER BY dd.DEPARTMENT_NAME) AS "진료과",
            asym.all_symptoms AS "전체증상목록",
            d.IMAGE_URL AS "이미지",
            d.DESCRIPTION AS "설명",
            d.TOTAL_PATIENTS AS "환자수"
        FROM DISEASES d
            LEFT JOIN DISEASE_DEPARTMENTS dd ON d.DISEASE_NAME = dd.DISEASE_NAME
            LEFT JOIN AllSymptoms asym ON d.DISEASE_NAME = asym.DISEASE_NAME
        GROUP BY d.DISEASE_NO, d.DISEASE_NAME, d.TOTAL_PATIENTS, d.IMAGE_URL, d.DESCRIPTION, asym.all_symptoms
        ORDER BY d.TOTAL_PATIENTS DESC NULLS LAST
    </select>
    <!-- Featured Diseases -->
    <select id="findAllFeaturedDiseases" resultType="com.hospital.boot.domain.diseases.model.vo.FeaturedDiseases">
        SELECT
        FEATURED_DISEASES_NO as featuredDiseasesNo,
        DISEASE_NAME as diseaseName,
        DISPLAY_ORDER as displayOrder,
        TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') as createdAt
        FROM FEATURED_DISEASES
        ORDER BY DISPLAY_ORDER
    </select>

    <insert id="insertFeaturedDisease" parameterType="com.hospital.boot.domain.diseases.model.vo.FeaturedDiseases">
        INSERT INTO FEATURED_DISEASES (
        FEATURED_DISEASES_NO,
        DISEASE_NAME,
        DISPLAY_ORDER
        ) VALUES (
        FEATURED_DISEASES_SEQ.NEXTVAL,
        #{diseaseName},
        #{displayOrder}
        )
    </insert>

    <delete id="deleteFeaturedDisease">
        DELETE FROM FEATURED_DISEASES
        WHERE FEATURED_DISEASES_NO = #{featuredDiseasesNo}
    </delete>

    <update id="updateFeaturedDiseaseOrder">
        UPDATE FEATURED_DISEASES
        SET DISPLAY_ORDER = #{item.displayOrder}
        WHERE FEATURED_DISEASES_NO = #{item.featuredDiseasesNo}
    </update>

    <!-- Disease CRUD -->
    <select id="findByDiseaseNo" resultType="com.hospital.boot.domain.diseases.model.vo.Diseases">
        SELECT
            DISEASE_NO as diseaseNo,
            DISEASE_NAME as diseaseName,
            IMAGE_URL as imageUrl,
            DESCRIPTION as description,
            TOTAL_PATIENTS as totalPatients
        FROM DISEASES
        WHERE DISEASE_NO = #{diseaseNo}
    </select>

    <insert id="insertDisease" parameterType="com.hospital.boot.domain.diseases.model.vo.Diseases">
        INSERT INTO DISEASES (
            DISEASE_NO,
            DISEASE_NAME,
            IMAGE_URL,
            DESCRIPTION
        ) VALUES (
            DISEASES_SEQ.NEXTVAL,
            #{diseaseName},
            #{imageUrl},
            #{description}
        )
    </insert>

    <update id="updateDisease" parameterType="com.hospital.boot.domain.diseases.model.vo.Diseases">
        UPDATE DISEASES
        SET DISEASE_NAME = #{diseaseName},
            DESCRIPTION = #{description}
            <if test="imageUrl != null and imageUrl != ''">
                , IMAGE_URL = #{imageUrl}
            </if>
        WHERE DISEASE_NO = #{diseaseNo}
    </update>

    <delete id="deleteDisease">
        DELETE FROM DISEASES
        WHERE DISEASE_NO = #{diseaseNo}
    </delete>

    <!-- Disease Departments -->
    <insert id="insertDiseaseDepartment">
        INSERT INTO DISEASE_DEPARTMENTS (DISEASE_NAME, DEPARTMENT_NAME)
        VALUES (#{diseaseName}, #{departmentName})
    </insert>

    <delete id="deleteDiseaseDepartments">
        DELETE FROM DISEASE_DEPARTMENTS
        WHERE DISEASE_NAME = #{diseaseName}
    </delete>

    <!-- Disease Symptoms -->
    <insert id="insertDiseaseSymptom">
        INSERT INTO DISEASE_SYMPTOM_MAPPINGS (DISEASE_NAME, SYMPTOM_NAME)
        VALUES (#{diseaseName}, #{symptomName})
    </insert>

    <delete id="deleteDiseaseSymptoms">
        DELETE FROM DISEASE_SYMPTOM_MAPPINGS
        WHERE DISEASE_NAME = #{diseaseName}
    </delete>
</mapper>