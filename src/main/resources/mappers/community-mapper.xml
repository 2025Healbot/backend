<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hospital.boot.domain.community.model.mapper.CommunityMapper">

    <select id="selectPostList"
            resultType="com.hospital.boot.app.community.dto.CommunityPostDto">
        SELECT
            p.POST_ID AS postId,
            p.MEMBER_ID AS memberId,
            m.USER_NAME AS author,
            p.CATEGORY AS category,
            p.TITLE AS title,
            p.CONTENT AS content,
            p.VIEWS AS views,
            p.CREATED_AT AS createdAt
        FROM COMMUNITY_POST p
        JOIN MEMBER m ON p.MEMBER_ID = m.MEMBER_ID
        WHERE p.STATUS = 'ACTIVE'
        <if test="category != 'all'">
            AND p.CATEGORY = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (LOWER(p.TITLE) LIKE '%' || LOWER(#{keyword}) || '%')
        </if>
        ORDER BY p.POST_ID DESC
    </select>
    
    <update id="increaseViews">
	    UPDATE COMMUNITY_POST
	    SET VIEWS = VIEWS + 1
	    WHERE POST_ID = #{postId}
	</update>

    <select id="selectPostDetail"
            parameterType="long"
            resultType="com.hospital.boot.app.community.dto.CommunityPostDto">
        SELECT
            p.POST_ID AS postId,
            p.MEMBER_ID AS memberId,
            m.USER_NAME AS author,
            p.CATEGORY AS category,
            p.TITLE AS title,
            p.CONTENT AS content,
            p.VIEWS AS views,
            p.CREATED_AT AS createdAt
        FROM COMMUNITY_POST p
        JOIN MEMBER m ON p.MEMBER_ID = m.MEMBER_ID
        WHERE p.POST_ID = #{postId}
    </select>

    <insert id="insertPost"
            parameterType="com.hospital.boot.domain.community.model.vo.Community">
        <selectKey keyProperty="postId" resultType="long" order="BEFORE">
            SELECT SEQ_COMMUNITY_POST.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO COMMUNITY_POST
        (POST_ID, MEMBER_ID, CATEGORY, TITLE, CONTENT, VIEWS, STATUS, CREATED_AT)
        VALUES
        (#{postId}, #{memberId}, #{category}, #{title}, #{content}, 0, 'ACTIVE', SYSDATE)
    </insert>

    <select id="selectCommentList"
            parameterType="long"
            resultType="com.hospital.boot.app.community.dto.CommunityCommentDto">
        SELECT
            c.COMMENT_ID AS commentId,
            c.POST_ID AS postId,
            c.MEMBER_ID AS memberId,
            m.USER_NAME AS author,
            c.CONTENT AS content,
            c.CREATED_AT AS createdAt
        FROM COMMUNITY_COMMENT c
        JOIN MEMBER m ON c.MEMBER_ID = m.MEMBER_ID
        WHERE c.POST_ID = #{postId}
        ORDER BY c.COMMENT_ID DESC
    </select>

    <insert id="insertComment"
            parameterType="com.hospital.boot.domain.community.model.vo.CommunityComment">
        <selectKey keyProperty="commentId" resultType="long" order="BEFORE">
            SELECT SEQ_COMMUNITY_COMMENT.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO COMMUNITY_COMMENT
            (COMMENT_ID, POST_ID, MEMBER_ID, CONTENT, CREATED_AT)
        VALUES
            (#{commentId}, #{postId}, #{memberId}, #{content}, SYSDATE)
    </insert>
    
    <delete id="deletePost">
       DELETE FROM COMMUNITY_POST
       WHERE POST_ID = #{postId}
         AND MEMBER_ID = #{memberId}
   </delete>
   
   <select id="countPostsByMember" resultType="int">
        SELECT COUNT(*)
        FROM COMMUNITY_POST
        WHERE MEMBER_ID = #{memberId}
          AND STATUS = 'ACTIVE'
    </select>

    <update id="updatePost">
        UPDATE COMMUNITY_POST
        SET TITLE = #{title},
            CONTENT = #{content},
            CATEGORY = #{category},
            UPDATED_AT = SYSDATE
        WHERE POST_ID = #{postId}
    </update>

    <update id="adminDeletePost">
        UPDATE COMMUNITY_POST
        SET STATUS = 'DELETED'
        WHERE POST_ID = #{postId}
    </update>
    
    <insert id="insertReport"
        parameterType="com.hospital.boot.domain.community.model.vo.CommunityReport">
	    INSERT INTO COMMUNITY_REPORT (
	        REPORT_ID,
	        TARGET_TYPE,
	        POST_ID,
	        COMMENT_ID,
	        REPORTER_ID,
	        REASON_TYPE,
	        DETAIL,
	        STATUS,
	        CREATED_AT
	    ) VALUES (
	        COMMUNITY_REPORT_SEQ.NEXTVAL,
	        #{targetType,  jdbcType=VARCHAR},
	        #{postId,     jdbcType=NUMERIC},
	        #{commentId,  jdbcType=NUMERIC},
	        #{reporterId, jdbcType=VARCHAR},
	        #{reasonType, jdbcType=VARCHAR},
	        #{detail,     jdbcType=VARCHAR},
	        NVL(#{status, jdbcType=VARCHAR}, 'PENDING'),
	        SYSDATE
	    )
	</insert>

    <select id="selectReportList" resultType="com.hospital.boot.app.community.dto.CommunityReportDto">
        SELECT
            r.REPORT_ID AS reportId,
            r.TARGET_TYPE AS targetType,
            r.POST_ID AS postId,
            r.COMMENT_ID AS commentId,
            r.REPORTER_ID AS reporterId,
            m.USER_NAME AS reporterName,
            r.REASON_TYPE AS reasonType,
            r.DETAIL AS detail,
            r.STATUS AS status,
            r.PENALTY_REASON AS penaltyReason,
            r.CREATED_AT AS createdAt,
            p.TITLE AS postTitle,
            c.CONTENT AS commentContent,
            CASE
                WHEN r.TARGET_TYPE = 'POST' THEN p.MEMBER_ID
                WHEN r.TARGET_TYPE = 'COMMENT' THEN c.MEMBER_ID
            END AS targetAuthorId
        FROM COMMUNITY_REPORT r
        LEFT JOIN MEMBER m ON r.REPORTER_ID = m.MEMBER_ID
        LEFT JOIN COMMUNITY_POST p ON r.POST_ID = p.POST_ID
        LEFT JOIN COMMUNITY_COMMENT c ON r.COMMENT_ID = c.COMMENT_ID
        <where>
            <if test="status != null and status != ''">
                AND r.STATUS = #{status}
            </if>
            <if test="targetType != null and targetType != ''">
                AND r.TARGET_TYPE = #{targetType}
            </if>
        </where>
        ORDER BY r.CREATED_AT DESC
    </select>

    <select id="selectReportDetail" parameterType="long" resultType="com.hospital.boot.app.community.dto.CommunityReportDto">
        SELECT
            r.REPORT_ID AS reportId,
            r.TARGET_TYPE AS targetType,
            r.POST_ID AS postId,
            r.COMMENT_ID AS commentId,
            r.REPORTER_ID AS reporterId,
            m.USER_NAME AS reporterName,
            r.REASON_TYPE AS reasonType,
            r.DETAIL AS detail,
            r.STATUS AS status,
            r.PENALTY_REASON AS penaltyReason,
            r.CREATED_AT AS createdAt,
            p.TITLE AS postTitle,
            c.CONTENT AS commentContent,
            CASE
                WHEN r.TARGET_TYPE = 'POST' THEN p.MEMBER_ID
                WHEN r.TARGET_TYPE = 'COMMENT' THEN c.MEMBER_ID
            END AS targetAuthorId
        FROM COMMUNITY_REPORT r
        LEFT JOIN MEMBER m ON r.REPORTER_ID = m.MEMBER_ID
        LEFT JOIN COMMUNITY_POST p ON r.POST_ID = p.POST_ID
        LEFT JOIN COMMUNITY_COMMENT c ON r.COMMENT_ID = c.COMMENT_ID
        WHERE r.REPORT_ID = #{reportId}
    </select>

    <update id="updateReportStatus">
        UPDATE COMMUNITY_REPORT
        SET STATUS = #{status},
            PENALTY_REASON = #{penaltyReason}
        WHERE REPORT_ID = #{reportId}
    </update>

    <delete id="deleteReport">
        DELETE FROM COMMUNITY_REPORT
        WHERE REPORT_ID = #{reportId}
    </delete>
    
    <!-- 내가 제재 받은 내역 (내 글/댓글이 신고되고 PENALTY_REASON 이 있는 것) -->
	<select id="selectMyReceivedSanctions"
	        parameterType="string"
	        resultType="com.hospital.boot.app.community.dto.MySanctionDto">
	
	    SELECT
	        r.REPORT_ID        AS reportId,
	        r.TARGET_TYPE      AS targetType,
	        r.POST_ID          AS postId,
	        r.COMMENT_ID       AS commentId,
	        r.REPORTER_ID      AS reporterId,
	        r.REASON_TYPE      AS reasonType,
	        r.DETAIL           AS detail,
	        r.STATUS           AS status,
	        r.PENALTY_REASON   AS penaltyReason,
	        TO_CHAR(r.CREATED_AT, 'YYYY-MM-DD HH24:MI') AS createdAt,
	        CASE
	            WHEN r.TARGET_TYPE = 'POST'
	              THEN SUBSTR(p.TITLE, 1, 80)
	            WHEN r.TARGET_TYPE = 'COMMENT'
	              THEN SUBSTR(c.CONTENT, 1, 80)
	            ELSE '(알 수 없음)'
	        END AS targetSummary
	    FROM COMMUNITY_REPORT r
	         LEFT JOIN COMMUNITY_POST p
	                ON r.POST_ID = p.POST_ID
	         LEFT JOIN COMMUNITY_COMMENT c
	                ON r.COMMENT_ID = c.COMMENT_ID
	    WHERE
	        r.PENALTY_REASON IS NOT NULL
	        AND (
	              (r.TARGET_TYPE = 'POST'    AND p.MEMBER_ID = #{memberId})
	           OR (r.TARGET_TYPE = 'COMMENT' AND c.MEMBER_ID = #{memberId})
	        )
	    ORDER BY r.REPORT_ID DESC
	</select>
	
	<!-- 내가 신고해서 제재까지 간 내역 (내가 신고자이고 PENALTY_REASON 이 있는 것) -->
	<select id="selectMyReportedSanctions"
	        parameterType="string"
	        resultType="com.hospital.boot.app.community.dto.MySanctionDto">
	
	    SELECT
	        r.REPORT_ID        AS reportId,
	        r.TARGET_TYPE      AS targetType,
	        r.POST_ID          AS postId,
	        r.COMMENT_ID       AS commentId,
	        r.REPORTER_ID      AS reporterId,
	        r.REASON_TYPE      AS reasonType,
	        r.DETAIL           AS detail,
	        r.STATUS           AS status,
	        r.PENALTY_REASON   AS penaltyReason,
	        TO_CHAR(r.CREATED_AT, 'YYYY-MM-DD HH24:MI') AS createdAt,
	        CASE
	            WHEN r.TARGET_TYPE = 'POST'
	              THEN SUBSTR(p.TITLE, 1, 80)
	            WHEN r.TARGET_TYPE = 'COMMENT'
	              THEN SUBSTR(c.CONTENT, 1, 80)
	            ELSE '(알 수 없음)'
	        END AS targetSummary
	    FROM COMMUNITY_REPORT r
	         LEFT JOIN COMMUNITY_POST p
	                ON r.POST_ID = p.POST_ID
	         LEFT JOIN COMMUNITY_COMMENT c
	                ON r.COMMENT_ID = c.COMMENT_ID
	    WHERE
	        r.REPORTER_ID  = #{memberId}
	        AND r.PENALTY_REASON IS NOT NULL
	    ORDER BY r.REPORT_ID DESC
	</select>
	
	<!-- 내가 받은 제재 개수 -->
	<select id="selectMySanctionCount"
	        parameterType="string"
	        resultType="int">
	    SELECT COUNT(*)
	    FROM COMMUNITY_REPORT r
	         LEFT JOIN COMMUNITY_POST p
	                ON r.POST_ID = p.POST_ID
	         LEFT JOIN COMMUNITY_COMMENT c
	                ON r.COMMENT_ID = c.COMMENT_ID
	    WHERE
	        r.PENALTY_REASON IS NOT NULL
	        AND (
	              (r.TARGET_TYPE = 'POST'    AND p.MEMBER_ID = #{memberId})
	           OR (r.TARGET_TYPE = 'COMMENT' AND c.MEMBER_ID = #{memberId})
	        )
	</select>
</mapper>